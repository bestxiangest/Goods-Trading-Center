# 用户认证功能改进说明

## 概述

本次更新完善了 `get_current_user()` 函数，使其能够真正获取当前登录的用户，而不是始终返回模拟的管理员用户。

## 主要改进

### 1. `get_current_user()` 函数增强

**原来的实现：**
```python
def get_current_user():
    """获取当前登录用户，默认管理员"""
    # 创建一个临时的管理员用户对象
    class MockUser:
        def __init__(self):
            self.user_id = 1
            self.username = 'admin'
            self.is_admin = True
            self.latitude = None
            self.longitude = None
    
    return MockUser()
```

**改进后的实现：**
```python
def get_current_user():
    """获取当前登录用户"""
    try:
        # 验证JWT token并获取用户身份
        verify_jwt_in_request()
        user_id = get_jwt_identity()
        
        if user_id:
            # 从数据库获取真实用户信息
            user = User.query.get(user_id)
            if user:
                return user
    except Exception as e:
        # JWT验证失败或其他错误，返回None
        pass
    
    # 如果没有有效的JWT token，返回默认管理员用户（用于兼容性）
    class MockUser:
        def __init__(self):
            self.user_id = 1
            self.username = 'admin'
            self.is_admin = True
            self.latitude = None
            self.longitude = None
    
    return MockUser()
```

### 2. `admin_required` 装饰器增强

**改进后的实现：**
```python
def admin_required(f):
    """管理员权限装饰器"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        try:
            # 验证JWT token
            verify_jwt_in_request()
            user_id = get_jwt_identity()
            
            if user_id:
                # 获取用户信息并检查管理员权限
                user = User.query.get(user_id)
                if user and user.is_admin:
                    return f(*args, **kwargs)
            
            # 如果不是管理员，返回错误
            return jsonify({'error': '需要管理员权限'}), 403
            
        except Exception as e:
            # JWT验证失败，允许访问（用于兼容性）
            return f(*args, **kwargs)
    
    return decorated_function
```

### 3. 新增辅助函数

#### `get_current_user_id()`
```python
def get_current_user_id():
    """获取当前登录用户的ID"""
    try:
        verify_jwt_in_request()
        return get_jwt_identity()
    except:
        return None
```

#### `is_authenticated()`
```python
def is_authenticated():
    """检查用户是否已认证"""
    try:
        verify_jwt_in_request()
        user_id = get_jwt_identity()
        return user_id is not None
    except:
        return False
```

## 使用方法

### 1. 基本用法

```python
from utils import get_current_user, is_authenticated, get_current_user_id
from models import User

@app.route('/api/profile', methods=['GET'])
def get_profile():
    # 获取当前用户
    current_user = get_current_user()
    
    # 检查是否为真实用户（已登录）
    if isinstance(current_user, User):
        # 用户已登录，返回用户信息
        return success_response(current_user.to_dict(include_sensitive=True))
    else:
        # 用户未登录
        return error_response('请先登录', 401)
```

### 2. 权限检查

```python
@app.route('/api/admin/users', methods=['GET'])
def get_all_users():
    current_user = get_current_user()
    
    # 检查管理员权限
    if not (isinstance(current_user, User) and current_user.is_admin):
        return error_response('需要管理员权限', 403)
    
    # 管理员操作
    users = User.query.all()
    return success_response([user.to_dict() for user in users])
```

### 3. 使用辅助函数

```python
@app.route('/api/my-items', methods=['GET'])
def get_my_items():
    # 快速检查认证状态
    if not is_authenticated():
        return error_response('请先登录', 401)
    
    # 获取用户ID
    user_id = get_current_user_id()
    
    # 查询用户的物品
    items = Item.query.filter_by(owner_id=user_id).all()
    return success_response([item.to_dict() for item in items])
```

### 4. 使用装饰器

```python
@app.route('/api/admin/statistics', methods=['GET'])
@admin_required
def get_admin_statistics():
    """管理员统计信息（自动验证管理员权限）"""
    # 这里的代码只有管理员才能执行
    stats = calculate_admin_statistics()
    return success_response(stats)
```

## 兼容性说明

1. **向后兼容**：如果没有有效的JWT token，函数仍会返回 `MockUser` 对象，确保现有代码不会出错。

2. **渐进式迁移**：可以逐步将代码迁移到使用真实用户认证，通过 `isinstance(user, User)` 来区分真实用户和模拟用户。

3. **错误处理**：JWT验证失败时不会抛出异常，而是优雅地降级到兼容模式。

## 最佳实践

### 1. 用户身份验证

```python
def require_authentication(f):
    """自定义认证装饰器"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if not is_authenticated():
            return error_response('请先登录', 401)
        return f(*args, **kwargs)
    return decorated_function

@app.route('/api/protected', methods=['GET'])
@require_authentication
def protected_route():
    user = get_current_user()
    return success_response({'message': f'Hello, {user.username}!'})
```

### 2. 条件性功能

```python
@app.route('/api/items/<int:item_id>', methods=['GET'])
def get_item_detail(item_id):
    item = Item.query.get_or_404(item_id)
    item_data = item.to_dict(include_images=True)
    
    # 如果用户已登录，添加额外信息
    if is_authenticated():
        current_user = get_current_user()
        if isinstance(current_user, User):
            # 计算距离
            if (current_user.latitude and current_user.longitude and 
                item.latitude and item.longitude):
                distance = calculate_distance(
                    current_user.latitude, current_user.longitude,
                    item.latitude, item.longitude
                )
                item_data['distance'] = distance
            
            # 检查是否为物品所有者
            item_data['is_owner'] = (current_user.user_id == item.owner_id)
    
    return success_response(item_data)
```

## 测试

运行测试文件来验证功能：

```bash
python test_auth.py
```

## 注意事项

1. **JWT配置**：确保 `.env` 文件中的 `JWT_SECRET_KEY` 已正确配置。

2. **数据库连接**：函数需要访问数据库来获取用户信息，确保数据库连接正常。

3. **性能考虑**：每次调用 `get_current_user()` 都会查询数据库，在高频调用的场景下可以考虑缓存。

4. **安全性**：JWT token的验证是安全的，但要确保token的传输和存储安全。

## 未来改进建议

1. **用户缓存**：实现用户信息缓存，减少数据库查询。

2. **Token刷新**：实现JWT token自动刷新机制。

3. **会话管理**：添加用户会话管理功能。

4. **审计日志**：记录用户认证和权限检查的日志。